<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trak Demo Org Dashboard</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #0f1a2e;
        --text: #e6edf6;
        --muted: #a8b3c7;
        --border: rgba(255, 255, 255, 0.08);
        --primary: #14b8a6;
        --danger: #ef4444;
        --warn: #f59e0b;
        --ok: #10b981;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(1200px 500px at 10% 0%, rgba(20, 184, 166, 0.25), transparent 60%),
          radial-gradient(900px 500px at 70% 10%, rgba(59, 130, 246, 0.18), transparent 55%), var(--bg);
        color: var(--text);
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 20px 56px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand img {
        width: 120px;
        height: 40px;
      }

      h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.2px;
      }

      .sub {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }

      .btn:hover {
        border-color: rgba(20, 184, 166, 0.5);
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 12px 0 6px;
      }

      .control {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 12px;
      }

      .control label {
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }

      .control input,
      .control select {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        min-width: 180px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
        margin: 18px 0 18px;
      }

      .card {
        border: 1px solid var(--border);
        background: rgba(15, 26, 46, 0.8);
        border-radius: 14px;
        padding: 14px;
      }

      .metric-label {
        color: var(--muted);
        font-size: 12px;
      }

      .metric-value {
        margin-top: 6px;
        font-size: 22px;
        font-weight: 800;
      }

      .table {
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: rgba(15, 26, 46, 0.8);
      }

      .row {
        display: grid;
        grid-template-columns: 1.6fr 1.2fr 1fr 0.7fr 0.9fr 2.6fr 0.7fr;
        gap: 12px;
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        align-items: center;
      }

      .row.header {
        position: sticky;
        top: 0;
        background: rgba(15, 26, 46, 0.95);
        z-index: 1;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.2px;
        text-transform: uppercase;
      }

      .row:last-child {
        border-bottom: 0;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
      }

      .pill.ok {
        border-color: rgba(16, 185, 129, 0.35);
        color: rgba(16, 185, 129, 1);
      }
      .pill.warn {
        border-color: rgba(245, 158, 11, 0.35);
        color: rgba(245, 158, 11, 1);
      }
      .pill.bad {
        border-color: rgba(239, 68, 68, 0.35);
        color: rgba(239, 68, 68, 1);
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .summary {
        color: var(--text);
        font-size: 13px;
        line-height: 1.35;
        opacity: 0.95;
      }

      .link {
        color: rgba(59, 130, 246, 1);
        text-decoration: none;
      }

      .link:hover {
        text-decoration: underline;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 50;
      }

      .modal {
        width: min(1000px, 100%);
        max-height: min(80vh, 900px);
        overflow: auto;
        border: 1px solid var(--border);
        background: rgba(15, 26, 46, 0.98);
        border-radius: 16px;
        padding: 16px;
      }

      .modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }

      .modal-title {
        margin: 0;
        font-size: 16px;
        font-weight: 800;
      }

      .kvs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 12px 0;
      }

      .kv {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 14px;
        padding: 10px 12px;
      }

      .kv .k {
        color: var(--muted);
        font-size: 12px;
      }

      .kv .v {
        margin-top: 6px;
        font-weight: 700;
      }

      .section-title {
        margin: 16px 0 10px;
        font-size: 13px;
        color: var(--muted);
        letter-spacing: 0.2px;
        text-transform: uppercase;
      }

      .list {
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }

      .item {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }

      .item:last-child {
        border-bottom: 0;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }

      .toast {
        position: fixed;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 26, 46, 0.98);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: none;
        z-index: 60;
        max-width: min(700px, 92vw);
      }

      @media (max-width: 980px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .row {
          grid-template-columns: 1.4fr 1fr 0.8fr 0.9fr;
        }
        .row .col-repo,
        .row .col-view {
          display: none;
        }
        .row .summary,
        .row.header .summary {
          display: none;
        }
      }

      @media (max-width: 520px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .row {
          grid-template-columns: 1fr;
        }
        .row.header {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          <img src="/logo.svg" alt="Trak" />
          <div>
            <h1>Organization Dashboard (Demo)</h1>
            <p class="sub">Live view of session reports received by the mock server.</p>
          </div>
        </div>
        <button class="btn" id="refreshBtn">Refresh</button>
      </header>

      <section class="controls">
        <div class="control">
          <label for="developerFilter">Developer</label>
          <select id="developerFilter">
            <option value="">All</option>
          </select>
        </div>
        <div class="control">
          <label for="repoFilter">Repo</label>
          <select id="repoFilter">
            <option value="">All</option>
          </select>
        </div>
        <div class="control">
          <label for="searchInput">Search</label>
          <input id="searchInput" placeholder="summary / file / type" />
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <div class="metric-label">Total Sessions</div>
          <div class="metric-value" id="totalSessions">0</div>
        </div>
        <div class="card">
          <div class="metric-label">Active Developers</div>
          <div class="metric-value" id="activeDevelopers">0</div>
        </div>
        <div class="card">
          <div class="metric-label">Average Quality</div>
          <div class="metric-value" id="avgQuality">0</div>
        </div>
        <div class="card">
          <div class="metric-label">Total Issues</div>
          <div class="metric-value" id="totalIssues">0</div>
        </div>
      </section>

      <section class="table">
        <div class="row header">
          <div>Developer</div>
          <div class="col-repo">Repo</div>
          <div>When</div>
          <div>Duration</div>
          <div>Quality</div>
          <div class="summary">Summary</div>
          <div class="col-view">View</div>
        </div>
        <div id="rows"></div>
      </section>

      <p class="muted" style="margin-top: 12px">
        Tip: run <code>cd demo && node mock-org-server.js</code> then configure <code>TRAK_ORG_ENDPOINT=http://localhost:3001</code>.
      </p>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modal-header">
          <div>
            <p class="modal-title" id="modalTitle">Session</p>
            <p class="sub" id="modalSub"></p>
          </div>
          <button class="btn" id="closeModalBtn">Close</button>
        </div>

        <div class="kvs">
          <div class="kv">
            <div class="k">Repository</div>
            <div class="v">
              <input id="modalRepoInput" class="mono" style="width: 100%" placeholder="owner/repo (for GitHub issue creation)" />
            </div>
          </div>
          <div class="kv">
            <div class="k">Quality</div>
            <div class="v" id="modalQuality"></div>
          </div>
          <div class="kv">
            <div class="k">When</div>
            <div class="v" id="modalWhen"></div>
          </div>
          <div class="kv">
            <div class="k">Duration</div>
            <div class="v" id="modalDuration"></div>
          </div>
        </div>

        <div class="section-title">Summary</div>
        <div class="kv"><div class="v" id="modalSummary"></div></div>

        <div class="section-title">Files Changed</div>
        <div class="list" id="modalFiles"></div>

        <div class="section-title">Findings</div>
        <div class="list" id="modalIssues"></div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const el = (id) => document.getElementById(id);
      const rowsEl = el("rows");
      const developerFilterEl = el("developerFilter");
      const repoFilterEl = el("repoFilter");
      const searchInputEl = el("searchInput");

      const modalBackdropEl = el("modalBackdrop");
      const closeModalBtnEl = el("closeModalBtn");
      const modalTitleEl = el("modalTitle");
      const modalSubEl = el("modalSub");
      const modalRepoInputEl = el("modalRepoInput");
      const modalQualityEl = el("modalQuality");
      const modalWhenEl = el("modalWhen");
      const modalDurationEl = el("modalDuration");
      const modalSummaryEl = el("modalSummary");
      const modalFilesEl = el("modalFiles");
      const modalIssuesEl = el("modalIssues");
      const toastEl = el("toast");

      let lastReports = [];
      let activeReport = null;

      function scoreClass(score) {
        if (score >= 80) return "ok";
        if (score >= 60) return "warn";
        return "bad";
      }

      function formatWhen(iso) {
        try {
          return new Date(iso).toLocaleString();
        } catch {
          return iso;
        }
      }

      function normalizeIssueCount(report) {
        if (Array.isArray(report.issueDetails)) return report.issueDetails.length;
        if (Array.isArray(report.issues)) return report.issues.length;
        return Number(report.issues || 0);
      }

      function normalizeChanges(report) {
        const changes = Array.isArray(report.changes) ? report.changes : [];
        return changes
          .map((c) => ({
            path: String(c.path || ""),
            type: String(c.type || "modified"),
            changeCount: Number(c.changeCount || 1),
          }))
          .filter((c) => c.path);
      }

      function normalizeIssues(report) {
        if (Array.isArray(report.issueDetails)) return report.issueDetails;
        if (Array.isArray(report.issues)) return report.issues;
        return [];
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function showToast(message) {
        toastEl.textContent = message;
        toastEl.style.display = "block";
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => {
          toastEl.style.display = "none";
        }, 3800);
      }

      function setOptions(selectEl, values) {
        const existing = new Set(Array.from(selectEl.options).map((o) => o.value));
        for (const v of values) {
          if (!existing.has(v)) {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            selectEl.appendChild(opt);
          }
        }
      }

      function applyFilters(reports) {
        const dev = developerFilterEl.value;
        const repo = repoFilterEl.value;
        const q = (searchInputEl.value || "").toLowerCase().trim();

        return reports.filter((r) => {
          if (dev && String(r.developerId || "") !== dev) return false;
          if (repo && String(r.repo || "") !== repo) return false;
          if (!q) return true;

          const hay = [
            r.developerName,
            r.developerId,
            r.repo,
            r.summary,
            ...normalizeChanges(r).map((c) => `${c.type} ${c.path}`),
            ...normalizeIssues(r).map((i) => `${i.type} ${i.severity} ${i.filePath} ${i.description}`),
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return hay.includes(q);
        });
      }

      function openModal(report) {
        activeReport = report;
        const score = Number(report.qualityScore || 0);
        const issueCount = normalizeIssueCount(report);
        const changes = normalizeChanges(report);

        modalTitleEl.textContent = `${report.developerName || "Unknown"} — Session`;
        modalSubEl.textContent = `${escapeHtml(report.developerId || "unknown")} · ${escapeHtml(
          report.sessionId || ""
        )}`;

        modalRepoInputEl.value = report.repo || localStorage.getItem("trakDemoRepo") || "";
        modalQualityEl.innerHTML = `<span class="pill ${scoreClass(score)}">${score}/100</span> <span class="muted" style="margin-left:8px">${issueCount} issues</span>`;
        modalWhenEl.textContent = formatWhen(report.timestamp || report.receivedAt || "");
        modalDurationEl.textContent = report.duration || "";
        modalSummaryEl.textContent = report.summary || "";

        const counts = { added: 0, modified: 0, deleted: 0, churn: 0 };
        for (const c of changes) {
          if (c.type === "added") counts.added++;
          else if (c.type === "deleted") counts.deleted++;
          else counts.modified++;
          counts.churn += Number(c.changeCount || 1);
        }

        modalFilesEl.innerHTML =
          changes.length === 0
            ? `<div class="item"><div class="muted">No file details were reported for this session.</div></div>`
            : `
              <div class="item">
                <div class="muted">Impact</div>
                <div class="muted">${counts.added} added · ${counts.modified} modified · ${counts.deleted} deleted · ${counts.churn} total edits</div>
              </div>
              ${changes
                .map((c) => {
                  const t = escapeHtml(c.type);
                  const p = escapeHtml(c.path);
                  const cc = escapeHtml(String(c.changeCount || 1));
                  const pill = `<span class="pill ${t === "deleted" ? "bad" : t === "added" ? "ok" : "warn"}">${t}</span>`;
                  return `<div class="item"><div>${pill} <span class="mono">${p}</span></div><div class="muted">${cc}x</div></div>`;
                })
                .join("")}
            `;

        const issues = normalizeIssues(report);
        modalIssuesEl.innerHTML =
          issues.length === 0
            ? `<div class="item"><div class="muted">No findings were reported for this session.</div></div>`
            : issues
                .map((i) => {
                  const sev = String(i.severity || "low");
                  const pill = `<span class="pill ${sev === "high" ? "bad" : sev === "medium" ? "warn" : "ok"}">${escapeHtml(
                    sev
                  )}</span>`;
                  const file = `${escapeHtml(i.filePath || "")}:${escapeHtml(String(i.lineNumber || ""))}`;
                  const title = escapeHtml(`${i.type || "issue"} — ${file}`);
                  const desc = escapeHtml(String(i.description || "")).slice(0, 260);
                  return `
                    <div class="item">
                      <div>
                        ${pill} <span class="mono">${title}</span>
                        <div class="muted" style="margin-top:6px">${desc}${String(i.description || "").length > 260 ? "…" : ""}</div>
                      </div>
                      <div>
                        <button class="btn" data-action="createIssue" data-issue-id="${escapeHtml(String(i.id || ""))}">Create issue</button>
                      </div>
                    </div>
                  `;
                })
                .join("");

        modalBackdropEl.style.display = "flex";
      }

      function closeModal() {
        modalBackdropEl.style.display = "none";
        activeReport = null;
      }

      async function createGitHubIssue(issueId) {
        const report = activeReport;
        if (!report) return;

        const repo = (modalRepoInputEl.value || "").trim();
        if (!repo) {
          showToast("Set a repo (owner/repo) to create issues.");
          return;
        }

        localStorage.setItem("trakDemoRepo", repo);

        const issue = normalizeIssues(report).find((i) => String(i.id || "") === String(issueId));
        if (!issue) {
          showToast("Could not find that issue in the report.");
          return;
        }

        showToast("Creating GitHub issue…");
        const res = await fetch("/api/github/issues", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ repo, report, issue }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          showToast(data.error || "Failed to create GitHub issue (check server GITHUB_TOKEN).");
          return;
        }

        showToast("Issue created.");
        if (data.issueUrl) {
          window.open(data.issueUrl, "_blank");
        }
      }

      async function load() {
        const res = await fetch("/api/sessions");
        const data = await res.json();
        const reports = Array.isArray(data.reports) ? data.reports : [];
        lastReports = reports;

        const totalSessions = reports.length;
        const activeDevelopers = new Set(reports.map((r) => r.developerId)).size;
        const avgQuality =
          reports.length > 0 ? Math.round(reports.reduce((sum, r) => sum + (r.qualityScore || 0), 0) / reports.length) : 0;
        const totalIssues = reports.reduce((sum, r) => sum + normalizeIssueCount(r), 0);

        el("totalSessions").textContent = totalSessions;
        el("activeDevelopers").textContent = activeDevelopers;
        el("avgQuality").textContent = avgQuality;
        el("totalIssues").textContent = totalIssues;

        setOptions(developerFilterEl, Array.from(new Set(reports.map((r) => String(r.developerId || "")).filter(Boolean))));
        setOptions(repoFilterEl, Array.from(new Set(reports.map((r) => String(r.repo || "")).filter(Boolean))));

        const filtered = applyFilters(reports);
        if (reports.length === 0) {
          rowsEl.innerHTML =
            '<div class="row"><div class="muted">No reports yet. Run a tracked session and stop it to send a report.</div></div>';
          return;
        }

        rowsEl.innerHTML = filtered
          .slice()
          .reverse()
          .map((r) => {
            const score = Number(r.qualityScore || 0);
            const pill = `<span class="pill ${scoreClass(score)}">${score}/100</span>`;
            const developer = `${escapeHtml(r.developerName || "Unknown")} <span class="muted">(${escapeHtml(
              r.developerId || "unknown"
            )})</span>`;
            const summary = escapeHtml(r.summary || "");
            const repo = escapeHtml(r.repo || "—");
            const viewBtn = `<button class="btn" data-action="view" data-session-id="${escapeHtml(String(r.sessionId || ""))}">View</button>`;

            return `
              <div class="row">
                <div>${developer}</div>
                <div class="mono col-repo">${repo}</div>
                <div class="muted">${escapeHtml(formatWhen(r.timestamp || r.receivedAt || ""))}</div>
                <div class="muted">${escapeHtml(r.duration || "")}</div>
                <div>${pill} <span class="muted" style="margin-left:8px">${escapeHtml(String(normalizeIssueCount(r)))} issues</span></div>
                <div class="summary">${summary}</div>
                <div class="col-view">${viewBtn}</div>
              </div>
            `;
          })
          .join("");
      }

      el("refreshBtn").addEventListener("click", () => load());
      developerFilterEl.addEventListener("change", () => load());
      repoFilterEl.addEventListener("change", () => load());
      searchInputEl.addEventListener("input", () => load());

      closeModalBtnEl.addEventListener("click", () => closeModal());
      modalBackdropEl.addEventListener("click", (e) => {
        if (e.target === modalBackdropEl) closeModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      rowsEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const action = btn.getAttribute("data-action");
        if (action === "view") {
          const sessionId = btn.getAttribute("data-session-id");
          const report = lastReports.find((r) => String(r.sessionId || "") === String(sessionId));
          if (report) openModal(report);
        }
      });

      modalIssuesEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action=\"createIssue\"]");
        if (!btn) return;
        createGitHubIssue(btn.getAttribute("data-issue-id"));
      });

      load();
      setInterval(load, 30_000);
    </script>
  </body>
</html>
